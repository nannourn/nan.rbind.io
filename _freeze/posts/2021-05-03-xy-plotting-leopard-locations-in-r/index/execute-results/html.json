{
  "hash": "3e151c410a7798036372b465f47eb836",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"xy: Plotting (Leopard) Locations in R\"\ndescription: \"Creating species occurrence maps with x,y location data.\"\nauthor:\n  - name: Nan Nourn\n    url: https://nan.seriousconservation.org\n    orcid: 0000-0001-5057-0640\n    affiliation: Michigan State University\n    affiliation-url: https://fw.msu.edu\ndate: 05-03-2021\ncategories: [R, GIS, sf, Spatial] #\nimage: preview-image.jpg\ndraft: false # setting this to `true` will prevent your post from appearing on your listing page until you're ready!\n---\n\nAs a wildlife biologist, one of the first steps in exploring spatial analyses with R is to produce a map with recorded (x, y) locations of your species of interest; for example, many researchers mark animal locations with a handheld Garmin GPS or obtain location data from GPS collars, and would like to see on a map where all the occurrences of their study animals have been recorded. I remember it took me forever just to learn this basic exercise so I thought it would be a nice blog post for students in the same position and beginning their spatial journey in becoming a **SAP** (Spatially Aware Professional).\n\nFor #InternationalLeopardDay, I thought it would be a fun and simple exercise to download recorded leopard (*Panthera pardus*) occurrence records from the GBIF database and to produce a basic leopard occurrence map.\n\nThe [Global Biodiversity Information Facility (GBIF)]('https://www.gbif.org/what-is-gbif') platform provides open access to biodiversity data, where many scientists have produced species distribution models and maps to explore global ranges for various wildlife species. We'll download leopard location data from GBIF and explore their range. **Note**: Like all open source databases, not all information inputted will be accurate. We'll have to use our best judgment to identify outlier points in GBIF, which mostly are attributed to user error.\n\nWe'll be using `dismo`, `sf` and `tidyverse` packages to download GBIF data and tidy our spatial data. Remember, if you're starting to work exclusively with spatial data, `sf` is a package I [suggest that you should spend some considerable time with]('https://r-spatial.github.io/sf/').\n\n# Packages\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(dismo)\nlibrary(sf)\nlibrary(tidyverse)\nlibrary(tmap)\nlibrary(maptiles)\n```\n:::\n\n\n# Downloading the data\n\nI use the `gbif` function to download records for leopards (*Panthera pardus*). I also use the option `geo=FALSE` to download records without numerical georeferences (records that do not come with location x,y data). `nrecs` is the argument to download the max number of records at a time, which is 300.\n\n\n::: {.cell}\n\n```{.r .cell-code}\npardus <- dismo::gbif(\"Panthera\",\"pardus\", geo = FALSE, nrecs = 300) \npardus %>% \n  as_tibble() %>% \n  head()\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 6 × 208\n  acceptedNameUsage acceptedScientificName   acceptedTaxonKey accessRights adm1 \n  <chr>             <chr>                               <int> <chr>        <chr>\n1 <NA>              Panthera pardus kotiya …          5219437 <NA>         Mone…\n2 <NA>              Panthera pardus kotiya …          5219437 <NA>         Mone…\n3 <NA>              Panthera pardus (Linnae…          5219436 <NA>         West…\n4 <NA>              Panthera pardus pardus            7193915 <NA>         Nort…\n5 <NA>              Panthera pardus fusca (…          5219442 <NA>         Raja…\n6 <NA>              Panthera pardus pardus            7193915 <NA>         Mpum…\n# ℹ 203 more variables: adm2 <chr>, associatedOccurrences <chr>,\n#   associatedReferences <chr>, associatedSequences <chr>,\n#   basionymAuthors <chr>, basionymYear <chr>, basisOfRecord <chr>, bed <chr>,\n#   behavior <chr>, bibliographicCitation <chr>, canonicalName <chr>,\n#   catalogNumber <chr>, class <chr>, classKey <int>, cloc <chr>,\n#   collectionCode <chr>, collectionID <chr>, collectionKey <chr>,\n#   combinationAuthors <chr>, combinationYear <chr>, continent <chr>, …\n```\n\n\n:::\n:::\n\n\n# Tidying the data\n\nThe data tibble seems to look okay, with at least 9,882 records being downloaded. With many columns of information provided by GBIF, we are mainly interested in `lon` and `lat` (x,y data) and `locality`. Let's summarize our data by determining among the downloaded records, how many have coordinates, and how many records do not have coordinates but have a textual geo-reference (locality description).\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# total number of records\npardus %>% count() \n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n     n\n1 9905\n```\n\n\n:::\n\n```{.r .cell-code}\n# looking at how many NA lon-lat records there are\npardus %>% \n  group_by(lon, lat) %>% \n  dplyr::count(sort = TRUE) %>% \n  unite(\"loc\", lon:lat, sep = \",\") %>%\n  mutate(loc = fct_reorder(loc, n)) %>%\n  slice_head(n = 5)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 5 × 2\n  loc                     n\n  <fct>               <int>\n1 NA,NA                2500\n2 35.420663,31.491912   495\n3 35.315413,31.492047   132\n4 34.965783,32.67288     66\n5 32.15,28.7666          60\n```\n\n\n:::\n\n```{.r .cell-code}\n# looking at a sample of localities recorded with NA coordinates\npardus %>%\n  filter(is.na(lat) | is.na(lon)) %>%\n  dplyr::count(locality, sort = TRUE) %>%\n  mutate(locality = fct_reorder(locality, n)) %>% \n  slice_sample(n = 10)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n                                 locality n\n1                            Ituri forest 1\n2                             Cochinchine 2\n3                           Rumathe River 1\n4                 Ahl al Oughlam - Site 1 3\n5                          Laristan, Fars 1\n6                             Mount Elgon 1\n7  Deutsch-Ostafrika (aus Familienbesitz) 1\n8                                  África 1\n9                              Masai Mara 1\n10                              Ethiopean 2\n```\n\n\n:::\n:::\n\n\nSo out of \\~9,800 records downloaded, 2,500 records do not have geo-referenced coordinates and were inputted as (NA,NA) in the dataset. A lot of the records that were not geo-referenced but had a recorded locality listed were sightings of leopards from zoos, and records that wouldn't be too particularly useful in producing a map, such as \"Africa\", \"on Simiyu River\", \"see remarks\", etc.\n\n# Static Map\n\nNow it's time to make a simple map. We just want to use records with (lon, lat) from our `pardus` tibble frame. From the `sf` package, we want to create an `sf` spatial object by using the `st_as_sf()` function to retrieve the coordinates, and then use the `st_set_crs()` function for our projection of choice.\n\nWe use the `geom_sf()` function with ggplot2 to put all the points together on the world map. Additionally, we can use the new `tm_basemap()` function to spice up our tmap.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# create sf obect with coordinations and projection\npardus_sf <- pardus %>% \n  filter(lon != is.na(lon) | lat != is.na(lat)) %>%\n  st_as_sf(coords = c(\"lon\", \"lat\"), remove = FALSE) %>% # key function \n  st_set_crs(4326)\n# load World map from tmap package\ndata(World)\n# combine sf objects to produce ggplot map\nggplot() +\n  geom_sf(data = World) +\n  geom_sf(data = pardus_sf, aes(color = \"Panthera pardus\"), alpha = 0.4) +\n  labs(title = \"Panthera pardus occurrences\",\n       subtitle = \"Source: GBIF\") +\n  scale_color_manual(name = \"locations\",\n                     values = \"black\") +\n  theme(legend.position = \"bottom\")\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/map-1-1.png){width=672}\n:::\n\n```{.r .cell-code}\n# tmap\ntm_shape(pardus_sf) +\n  tm_dots(fill = \"black\", fill_alpha = 0.4) +\n  tm_graticules() +\n  tm_basemap(\"OpenTopoMap\")\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/map-1-2.png){width=672}\n:::\n:::\n\n\nSome thoughts on the initial global map include records indicating leopards occurring in North and South America and Europe, which come as a surprise to me. These were probably occurrences in zoos or other captive facilities listed by public citizens. Thus, it is probably best to know a few things on current distribution of your focal species of interest before integrating records from public databases, such as GBIF. Also, I am aware I did not include a north arrow or scale bar for this map, as this is only a draft and not finalized for any publications.\n\nHowever, we can create a second map that focuses on Africa and Asia continents to get a clearer look at more natural leopard occurrences. We do this by filtering the areas of interest (Africa and Asia) in our World object. We then make sure the projections for both `pardus_sf_aa` and `africa_asia` objects are the same so that we can use the `st_intersection()` function to clip the locations that fall outside our Africa and Asia polygon, so that points in North America, South America and Europe don't show up on the map. The `st_crs()` argument is handy for extracting the CRS information from an object, and the `st_transform()` argument lets you change the CRS information for a given object. Changing the alpha value on the `pardus_sf_aa` points can show the density of locations; darker points show us that an aggregation of occurrences are mainly in southern Africa and India.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# filter world map for asia and africa continent\nafrica_asia <- World %>% filter(continent==\"Africa\" | continent == \"Asia\")\n# set CRS for africa_asia the same as pardus\nmyCRS <- st_crs(pardus_sf)\nafrica_asia <- africa_asia %>% st_transform(myCRS)\n# check CRS\nst_crs(africa_asia)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nCoordinate Reference System:\n  User input: EPSG:4326 \n  wkt:\nGEOGCRS[\"WGS 84\",\n    ENSEMBLE[\"World Geodetic System 1984 ensemble\",\n        MEMBER[\"World Geodetic System 1984 (Transit)\"],\n        MEMBER[\"World Geodetic System 1984 (G730)\"],\n        MEMBER[\"World Geodetic System 1984 (G873)\"],\n        MEMBER[\"World Geodetic System 1984 (G1150)\"],\n        MEMBER[\"World Geodetic System 1984 (G1674)\"],\n        MEMBER[\"World Geodetic System 1984 (G1762)\"],\n        MEMBER[\"World Geodetic System 1984 (G2139)\"],\n        MEMBER[\"World Geodetic System 1984 (G2296)\"],\n        ELLIPSOID[\"WGS 84\",6378137,298.257223563,\n            LENGTHUNIT[\"metre\",1]],\n        ENSEMBLEACCURACY[2.0]],\n    PRIMEM[\"Greenwich\",0,\n        ANGLEUNIT[\"degree\",0.0174532925199433]],\n    CS[ellipsoidal,2],\n        AXIS[\"geodetic latitude (Lat)\",north,\n            ORDER[1],\n            ANGLEUNIT[\"degree\",0.0174532925199433]],\n        AXIS[\"geodetic longitude (Lon)\",east,\n            ORDER[2],\n            ANGLEUNIT[\"degree\",0.0174532925199433]],\n    USAGE[\n        SCOPE[\"Horizontal component of 3D system.\"],\n        AREA[\"World.\"],\n        BBOX[-90,-180,90,180]],\n    ID[\"EPSG\",4326]]\n```\n\n\n:::\n\n```{.r .cell-code}\nst_crs(pardus_sf)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nCoordinate Reference System:\n  User input: EPSG:4326 \n  wkt:\nGEOGCRS[\"WGS 84\",\n    ENSEMBLE[\"World Geodetic System 1984 ensemble\",\n        MEMBER[\"World Geodetic System 1984 (Transit)\"],\n        MEMBER[\"World Geodetic System 1984 (G730)\"],\n        MEMBER[\"World Geodetic System 1984 (G873)\"],\n        MEMBER[\"World Geodetic System 1984 (G1150)\"],\n        MEMBER[\"World Geodetic System 1984 (G1674)\"],\n        MEMBER[\"World Geodetic System 1984 (G1762)\"],\n        MEMBER[\"World Geodetic System 1984 (G2139)\"],\n        MEMBER[\"World Geodetic System 1984 (G2296)\"],\n        ELLIPSOID[\"WGS 84\",6378137,298.257223563,\n            LENGTHUNIT[\"metre\",1]],\n        ENSEMBLEACCURACY[2.0]],\n    PRIMEM[\"Greenwich\",0,\n        ANGLEUNIT[\"degree\",0.0174532925199433]],\n    CS[ellipsoidal,2],\n        AXIS[\"geodetic latitude (Lat)\",north,\n            ORDER[1],\n            ANGLEUNIT[\"degree\",0.0174532925199433]],\n        AXIS[\"geodetic longitude (Lon)\",east,\n            ORDER[2],\n            ANGLEUNIT[\"degree\",0.0174532925199433]],\n    USAGE[\n        SCOPE[\"Horizontal component of 3D system.\"],\n        AREA[\"World.\"],\n        BBOX[-90,-180,90,180]],\n    ID[\"EPSG\",4326]]\n```\n\n\n:::\n\n```{.r .cell-code}\n# now union\npardus_sf_aa <- st_intersection(pardus_sf, africa_asia)\n# combine sf objects to produce ggplot map\nggplot() +\n  geom_sf(data = africa_asia) +\n  geom_sf(data = pardus_sf_aa, aes(color = \"Panthera pardus\"), alpha = 0.4) +\n  labs(title = \"Panthera pardus occurrences in Africa and Asia\",\n       subtitle = \"Source: GBIF\") +\n  scale_color_manual(name = \"locations\",\n                     values = \"darkorange\") +\n  theme(legend.position = \"bottom\")\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/map-2-1.png){width=672}\n:::\n\n```{.r .cell-code}\n# tmap\ntm_shape(pardus_sf_aa) +\n  tm_dots(fill = \"darkorange\", fill_alpha = 0.4) +\n  tm_graticules() +\n  tm_basemap(\"Esri.WorldTopoMap\")\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/map-2-2.png){width=672}\n:::\n:::\n\n\n# Interactive Map\n\nI am also a big fan of producing interactive maps for quicker access to explore the data interactively. `tmap` provides an html interactive map mode for this task. You'll notice that the way to produce a `tmap` is similar to producing a map with the `ggplot` syntax.\n\n\n::: {.cell}\n\n```{.r .cell-code}\npardus_int <- tm_shape(pardus_sf_aa) +\n  tm_dots(fill_alpha = 0.4, fill = \"darkorange\") +\n  tm_view(use.WebGL = FALSE)\n```\n:::\n\n\nView the interactive tmap!\n\n\n::: {.cell .column-screen}\n\n```{.r .cell-code}\ntmap_leaflet(pardus_int, show = TRUE)\n```\n:::\n\n",
    "supporting": [
      "index_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}